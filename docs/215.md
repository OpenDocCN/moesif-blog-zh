# 针对参数和查询字符串使用的 REST API 设计最佳实践

> 原文：<https://www.moesif.com/blog/technical/api-design/REST-API-Design-Best-Practices-for-Parameters-and-Query-String-Usage/>

当我们设计 API 的时候，我们的目标是让我们的用户在我们提供的服务上拥有一定的权力。虽然 HTTP 动词和资源 URL 允许一些基本的交互，但经常需要提供额外的功能，否则系统会变得太麻烦而无法使用。

这方面的一个例子是分页:如果我们的数据库中有数百万篇文章，我们不可能在一次响应中将每篇文章都发送给客户。

实现这一点的一种方法是使用**参数化**。

## 什么是参数化

一般来说，参数化是一种请求配置。

在编程语言中，我们可以从函数中请求返回值。如果函数不带任何参数，我们就不能直接影响这个返回值。

API 也是如此，尤其是像 REST APIs 这样的无状态 API。罗伊·菲尔丁雄辩地说:

> 所有 REST 交互都是无状态的。也就是说，每个请求都包含连接器理解请求所需的所有信息，独立于之前的任何请求。

在 HTTP 中，有许多方法可以向请求添加参数:查询字符串、POST、PUT 和 PATCH 请求的主体以及头部。每个都有自己的用例及规则。

添加所有参数数据的最简单方法是将所有内容都放在主体中。许多 API 都是这样工作的。每个端点都使用 POST，所有参数都在主体中。这在遗留 API 中尤其如此，这些 API 在十年左右的时间里积累了越来越多的参数，以至于它们不再适合查询字符串。

虽然这种情况经常发生，但我认为这是 API 设计中的一种边缘情况。如果我们一开始就提出正确的问题，我们可以避免这样的结果。

## 我们想要添加什么样的参数？

我们应该问自己的第一个问题是*我们想要添加什么样的参数？*

也许它是一个参数，是 HTTP 规范中已经标准化的[头字段。](http://www.rfcreader.com/#rfc2616_line4589)

有很多标准化的领域。有时我们可以重新发明轮子，把信息添加到另一个地方。我不是说我们不能用不同的方式。例如，从 REST 的角度来看，GraphQL 做了一些我认为疯狂的事情，但它仍然可以工作。有时候使用已经存在的东西会更简单。

以`Accept`标题为例。这允许我们定义响应应该采用的格式，或*媒体类型*。我们可以用这个来告诉 API 我们需要`JSON`或者`XML`。我们也可以用它来获得 API 的[版本。](/blog/technical/api-design/Best-Practices-for-Versioning-REST-and-GraphQL-APIs)

还有一个`Cache-Control`头，我们可以用它来阻止 API 向我们发送带有`no-cache`的缓存响应，而不是使用一个查询字符串作为*缓存破坏者* ( `?cb=<RANDOM_STRING>`)

授权也可以被视为一个参数。根据 API 授权的细节，授权或未授权可能导致不同的响应。 [HTTP 为此定义了一个`Authorization`](http://www.rfcreader.com/#rfc2616_line4922) 报头。

在我们检查了所有默认的头字段之后，下一步是评估我们是否应该为我们的参数创建一个定制的头字段，或者将它放入我们的 URL 的查询字符串中。

## 我们什么时候应该使用查询字符串？

如果我们知道要添加的参数不属于默认的头字段，并且不敏感，我们应该看看查询字符串是否适合它们。

顾名思义，历史上使用查询字符串是为了查询数据。有一个`<isindex>` HTML 元素可以用来向服务器发送一些关键字，服务器会用一个匹配这些关键字的页面列表来响应。

后来，查询字符串被重新用于 web 表单，通过 GET 请求向服务器发送数据。

因此，查询字符串的主要用例是过滤，特别是过滤的两个特例:搜索和分页。我不会在这里赘述，因为我们已经在本文中解决了它们[。](/blog/technical/api-design/REST-API-Design-Filtering-Sorting-and-Pagination/)

但是正如 web 表单的重用所示，它也可以用于不同类型的参数。RESTful API 可以使用 POST 或 PUT 请求将表单数据发送到服务器。

嵌套表示的参数就是一个例子。默认情况下，我们返回一篇文章的普通表示。当一个`?withComments`查询字符串被添加到端点时，我们内联返回该文章的评论，因此只需要一个请求。

这样的参数应该放在自定义标题中还是查询字符串中，这主要是开发人员的经验问题。

HTTP 规范声明标题字段有点像函数参数，所以它们确实被认为是我们想要使用的参数。然而，在这种情况下，**向 URL 添加一个查询字符串会很快完成，并且比创建一个客户头更明显。**

> 这些字段充当请求修饰符，语义相当于编程语言方法调用的参数。

在所有端点上保持相同的参数更适合于头。例如，每个请求都会发送身份验证令牌。

高度动态的参数，尤其是当它们仅对少数端点有效时，应该放在查询字符串中。例如，每个端点的过滤器参数都不同。

## 额外收获:数组和映射参数

经常出现的一个问题是**如何处理查询字符串中的数组参数？**

例如，如果我们想要搜索多个名字。

一种解决方案是使用方括号。

```py
/authors?name[]=kay&name[]=xing 
```

但是 HTTP 规范规定:

> 由 Internet 协议文字地址(版本 6[RFC3513]或更高版本)标识的主机通过将 IP 文字括在方括号(“[”和“]”)中来区分。这是 URI 语法中唯一允许方括号字符的地方。

HTTP 服务器和客户端的许多实现并不关心这个事实，但是应该记住这一点。

提供的另一个解决方案是简单地多次使用一个参数名:

```py
/authors?name=kay&name=xing 
```

这是一个有效的解决方案，但是会导致开发人员体验的下降。通常，客户端只是使用一种类似地图的数据结构，在添加到 URL 之前经过简单的字符串转换，这可能会导致覆盖以下值。在发送请求之前，需要进行更复杂的转换。

另一种方法是用`,`字符分隔值，这在 URL 中是允许的。

```py
/authors?name=kay,xing 
```

对于类似地图的数据结构，我们可以使用`.`字符，它也允许不编码。

```py
/articles?age.gt=21&age.lt=40 
```

还可以对整个查询字符串进行 URL 编码，这样它就可以使用我们想要的任何字符或格式。应该记住，这也会大大降低开发人员的体验。

## 什么时候不应该使用查询字符串？

查询字符串是我们的 URL 的一部分，我们的 URL 可以被坐在客户端和 API 之间的每个人读取，所以我们不应该将密码之类的敏感数据放在查询字符串中。

此外，如果我们不认真对待 URL 的设计和长度，开发者的体验会大打折扣。当然，大多数 HTTP 客户端允许 URL 中的字符长度为五位数，但是调试这样的字符串并不令人愉快。

因为任何东西都可以被定义为资源，所以对于大量使用参数的情况，有时使用 POST 端点可能更有意义。这让我们可以将主体中的所有数据发送给 API。

我们可以把它设计成一个资源(比如 search-resource)，而不是向查询字符串中有多个参数的资源发送 GET 请求，这可能导致一个很长的不可调试的 URL。根据我们的 API 需要做什么来满足我们的请求，我们甚至可以用它来缓存我们的计算结果。

我们将向我们的`/searches`端点发送一个新的请求，它将我们的搜索配置/参数保存在主体中。返回一个搜索 ID，稍后我们可以使用它来获得搜索结果。

## 结论

与所有最佳实践一样，作为 API 设计者和架构师，我们的工作不是遵循一种方法作为“最佳解决方案”，而是找出我们的 API 是如何被使用的。

最常见的用例应该是最容易完成的，用户应该很难做错事。

因此，从一开始就分析我们的 API 使用模式总是很重要的——我们越早获得数据，如果我们搞乱了我们的设计，就越容易实现改变。Moesif 的分析服务可以帮上忙。

> [Moesif](https://www.moesif.com/features/api-analytics) 是最先进的 API 分析服务，被数以千计的平台用来衡量其客户的使用模式。

如果我们走一条路，因为它更容易掌握或更容易实现，我们必须看看我们从中获得了什么。

由于嵌套资源可以用来使 URL 更可读，如果我们嵌套太多，它们也会变得太长而不可读。参数也是如此。如果我们发现自己创建了一个包含大量查询字符串的端点，那么最好从其中提取另一个资源，并在主体内部发送参数。